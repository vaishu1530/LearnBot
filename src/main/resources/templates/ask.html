<!DOCTYPE html>
<html xmlns:th="[http://www.thymeleaf.org](http://www.thymeleaf.org)">
<head>
    <title>LearnBot AI</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 20px auto; padding: 20px; }
        .ans-container { border-left: 5px solid #007bff; padding: 20px; background: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        .mermaid-container { margin-top: 30px; padding: 15px; background: #fff; border: 2px dashed #007bff; border-radius: 8px; display: flex; justify-content: center; }
        b { color: #007bff; }
    </style>
    <script type="module">
        import mermaid from '[https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs](https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs)';
        mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });
        window.mermaid = mermaid;
    </script>
</head>
<body>
    <div class="ans-container">
        <div id="raw-ans" style="display:none;" th:text="${botResponse}"></div>
        
        <div id="text-output"></div>
        <div id="graph-output" class="mermaid-container"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const raw = document.getElementById('raw-ans').innerText;
            const textOutput = document.getElementById('text-output');
            const graphOutput = document.getElementById('graph-output');

            // 1. Separate Text and Diagram using our custom markers
            const parts = raw.split("[DIAGRAM_START]");
            const mainText = parts[0].trim();
            const diagramPart = parts[1] ? parts[1].split("[DIAGRAM_END]")[0].trim() : null;

            // 2. Format and display the text
            textOutput.innerHTML = mainText.replace(/\n/g, "<br>");

            // 3. Render the diagram safely
            if (diagramPart && window.mermaid) {
                try {
                    const diagDiv = document.createElement('div');
                    diagDiv.className = 'mermaid';
                    diagDiv.innerHTML = diagramPart;
                    graphOutput.appendChild(diagDiv);
                    
                    await window.mermaid.run({ nodes: [diagDiv] });
                } catch (err) {
                    graphOutput.innerHTML = "<p style='color:red;'>Diagram Error: " + err.message + "</p>";
                }
            } else {
                graphOutput.style.display = 'none';
            }
        });
    </script>
</body>
</html>